# Integration Guide

This page summarizes how the Data Pipeline Ingest API and official SDKs work: authentication, endpoints, data models, error handling, rate limits, and best practices.

## Authentication

The API uses **dual-layer security**. The SDK handles it for you.

1. **Token**: Sent in the `x-optikpi-token` header.
2. **HMAC signature**: Each request is signed with HMAC-SHA256 using HKDF key derivation.
3. **Headers**: The SDK adds `x-optikpi-account-id`, `x-optikpi-workspace-id`, and signature headers.

You need (from your account manager):

- **Authentication token**
- **Account ID** and **Workspace ID**
- **API Gateway URL** (base URL for ingest)

::: tip
Provide these once when initializing the SDK; no crypto code is required on your side.
:::

## API Endpoints

**Base URL:** `https://your-api-gateway-url/apigw/ingest`

| Endpoint                  | Method | Description            | Rate limit  |
| ------------------------- | ------ | ---------------------- | ----------- |
| `/customers`              | POST   | Customer profile data  | 50 req/sec  |
| `/events/account`         | POST   | Account events         | 250 req/sec |
| `/events/deposit`         | POST   | Deposit events         | 250 req/sec |
| `/events/withdraw`        | POST   | Withdrawal events      | 250 req/sec |
| `/events/gaming-activity` | POST   | Gaming activity events | 250 req/sec |
| `/events/wallet-balance`  | POST   | Wallet balance events  | 250 req/sec |
| `/events/refer-friend`    | POST   | Refer friend events    | 250 req/sec |
| `/extattributes`          | POST   | Extended attributes    | 50 req/sec  |

### Required headers (SDK sets these)

| Header                   | Description                  |
| ------------------------ | ---------------------------- |
| `x-optikpi-account-id`   | Your account identifier      |
| `x-optikpi-workspace-id` | Your workspace identifier    |
| `x-optikpi-token`        | Authentication token         |
| Signature headers        | HMAC/HKDF (generated by SDK) |

### Success response

```json
{
  "message": "Success description",
  "recordIds": ["record-id-1", "record-id-2"],
  "count": 2
}
```

### Batch payload keys

When using `sendBatch` (or equivalent), the payload uses the keys below. Each key is optional; omit or pass an empty array if you have no data. **Max 500 records total** per batch request.

| Key                 | Description                             |
| ------------------- | --------------------------------------- |
| customers           | Customer profiles                       |
| accountEvents       | Account events                          |
| depositEvents       | Deposit events                          |
| withdrawEvents      | Withdrawal events                       |
| gamingEvents        | Gaming activity events                  |
| walletBalanceEvents | Wallet balance events                   |
| referFriendEvents   | Refer friend events                     |
| extendedAttributes  | Extended attributes                     |
| operationEvents     | Operations events (JavaScript SDK only) |

## Data models (summary)

- **Customer profile**: `account_id`, `workspace_id`, `user_id`, `creation_timestamp` (required); plus username, email, currency, limits, verification status, preferences, etc.
- **Account event**: `account_id`, `workspace_id`, `user_id`, `event_category`, `event_name`, `event_id`, `event_time`.
- **Deposit / Withdraw event**: Same common fields plus `amount`; deposit includes `payment_method`, `transaction_id`, etc.
- **Gaming activity event**: Common fields plus `wager_amount`, `win_amount`, `game_id`, `game_title`, and many optional game/session fields.
- **Wallet balance event**: Common fields plus `wallet_type`, `currency`, `current_cash_balance`, `current_bonus_balance`, `current_total_balance`.
- **Refer friend event**: Common fields plus `referral_code_used`, `successful_referral_confirmation`, `reward_type`, `referee_user_id`, etc.
- **Extended attributes**: `workspace_id`, `user_id`, `list_name`, `ext_data` (JSON object or string).

All date-time fields use **ISO 8601 UTC** (e.g. `2024-01-15T10:30:00Z`). Full field-level schemas are in the repository: [INTEGRATION_GUIDE.md](https://github.com/gamingcrafts/optikpi-datapipeline-sdk/blob/main/INTEGRATION_GUIDE.md) (Customer Profile, Account/Deposit/Withdraw/Gaming/Wallet/Refer Friend/Extended Attributes tables).

## Error handling

### HTTP status codes

| Code | Meaning           | Action                         |
| ---- | ----------------- | ------------------------------ |
| 200  | Success           | Request processed              |
| 400  | Bad Request       | Check body and required fields |
| 401  | Unauthorized      | Verify token and signature     |
| 403  | Forbidden         | Token may be expired/invalid   |
| 404  | Not Found         | Check base URL and path        |
| 429  | Too Many Requests | Back off; respect rate limits  |
| 500  | Server Error      | Retry after a delay            |

### Error response shape

```json
{
  "error": "Bad Request",
  "message": "Validation failed: account_id is required",
  "details": { "field": "account_id", "issue": "missing required field" }
}
```

The SDK returns a result object with `success` and either `data` or error details. It implements **retry with exponential backoff** for transient failures; avoid retrying on 4xx client errors.

## Rate limits

- **Customer and extended attributes**: 50 requests per second
- **Event endpoints**: 250 requests per second
- **Batch size**: Up to 500 records per batch request
- **Window**: 1 minute
- **On limit**: API returns **429 Too Many Requests**

## Best practices

1. **Validate before send** — Use the SDK’s model `validate()` to catch errors locally.
2. **Batching** — Use batch endpoints for bulk data; keep batch size within limits.
3. **Errors** — Use exponential backoff on 5xx/429; do not retry 4xx without fixing the request.
4. **Security** — Keep tokens secret, use HTTPS, avoid logging sensitive payloads.
5. **Monitoring** — Log response times and failure rates; set alerts for high error rates.

## Support

- **Documentation**: [OptiKPI User Guide](https://www.optikpi.com/user-guide/)
- **SDK & issues**: [GitHub: optikpi-datapipeline-sdk](https://github.com/gamingcrafts/optikpi-datapipeline-sdk/issues)

## Next steps

- Pick an SDK: [JavaScript](/data-pipeline-sdk/javascript), [Java](/data-pipeline-sdk/java), [Python](/data-pipeline-sdk/python), [PHP](/data-pipeline-sdk/php).
- Get credentials from your account manager and configure the client.
- Send a test customer profile and one event, then add batching and error handling as needed.
